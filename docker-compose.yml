version: "3"
services:
  dashboard-app:
    build: .
    expose:
      - 8000
    restart: on-failure
    depends_on:
      postgres-db:
        condition: service_healthy

  postgres-db:
    image: postgres:14.5
    environment:
      POSTGRES_USER_FILE: /run/secrets/db-user
      POSTGRES_PASSWORD_FILE: /run/secrets/db-password
    secrets:
      - db-user
      - db-password
    ports:
      - "5432:5432"  
    restart: on-failure 
    volumes:
      - insight-postgres-data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -d insight-db -U insight-db"]
      interval: 10s
      timeout: 5s
      retries: 5
      
  nginx-server:
    build: ./nginx-server
    ports:
      - 8080:80
    restart: on-failure
    depends_on:
      postgres-db:
        condition: service_healthy

  db-fill:
    build: ./db-setup
    depends_on:
      postgres-db:
        condition: service_healthy

secrets:
  db-user:
    file: credentials/db-user.txt
  db-password:
    file: credentials/db-password.txt
  db-name:
    file: credentials/db-name.txt    

volumes:
  insight-postgres-data: